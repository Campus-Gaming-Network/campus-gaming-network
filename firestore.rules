rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    ///////////////////////////////////////////////////////////////////////////
    // Rules

    match /users/{userId} {
        function canCreateUser() {
          return isValidUser();
        }

        function isValidUser() {
          let requiredFields = [
            'firstName',
            'lastName',
            'status',
            'gravatar',
            'school',
          ];
          let optionalFields = [
            'major',
            'minor',
            'bio',
            'timezone',
            'hometown',
            'birthdate',
            'website',
            'twitter',
            'twitch',
            'youtube',
            'skype',
            'discord',
            'battlenet',
            'steam',
            'xbox',
            'psn',
            'currentlyPlaying',
            'favoriteGames'
          ];
          let statusOptions = [
            "FRESHMAN",
            "SOPHMORE",
            "JUNIOR",
            "SENIOR",
            "GRAD",
            "ALUMNI",
            "FACULTY",
            "OTHER"
          ];
          let timezoneOptions = [
            "",
            "America/Puerto_Rico",
            "America/New_York",
            "America/Chicago",
            "America/Denver",
            "America/Phoenix",
            "America/Los_Angeles",
            "America/Anchorage",
            "Pacific/Honolulu",
          ];

          return (
            documentFieldsCheckOut(requiredFields, optionalFields) &&
            hasLength('firstName', 1, 255) &&
            hasLength('lastName', 1, 255) &&
            hasLength('status', 1, 15) &&
            hasLength('gravatar', 1, 255) &&
            isValidOption("status", statusOptions) &&
            (has('major') && hasLength('major', 0, 255)) &&
            (has('minor') && hasLength('minor', 0, 255)) &&
            (has('bio') && hasLength('bio', 0, 2500)) &&
            (has('timezone') && isValidOption("timezone", timezoneOptions)) &&
            (has('hometown') && hasLength('hometown', 0, 255)) &&
            (has('birthdate') && incomingData().birthdate is timestamp) &&
            (has('twitter') && hasLength('twitter', 0, 255)) &&
            (has('twitch') && hasLength('twitch', 0, 255)) &&
            (has('youtube') && hasLength('youtube', 0, 255)) &&
            (has('skype') && hasLength('skype', 0, 255)) &&
            (has('discord') && hasLength('discord', 0, 255)) &&
            (has('battlenet') && hasLength('battlenet', 0, 255)) &&
            (has('steam') && hasLength('steam', 0, 255)) &&
            (has('xbox') && hasLength('xbox', 0, 255)) &&
            (has('psn') && hasLength('psn', 0, 255)) &&
            (has('currentlyPlaying') && incomingData().currentlyPlaying.size() <= 5) &&
            (has('favoriteGames') && incomingData().favoriteGames.size() <= 5)
          );
        }

        function canUpdateUser() {
          return (
            isOwner(userId) &&
            isValidUser()
          );
        }

        function canDeleteUser() {
          return (
            isOwner(userId)
          );
        }

      allow read: if true;
      allow create: if canCreateUser();
      allow update: if canUpdateUser();
      allow delete: if canDeleteUser();
      allow write: if false;
    }

    match /events/{eventId} {
      function canCreateEvent() {
        return isSignedIn();
        // return (
        //   isSignedIn() &&
        //   userHasSchool(getUserData())
        // );
      }

      function isValidEvent() {
        let requiredFields = [
          'creator',
          'host',
          'name',
          'game',
          'startDateTime',
          'endDateTime',
          'isOnlineEvent',
          'school',
        ];
        let optionalFields = [
          'description',
          'location',
          'placeId',
        ];
        return documentFieldsCheckOut(requiredFields, optionalFields);
      }

      function canUpdateEvent() {
        return canCreateEvent()
        // return (
        //   canCreateEvent(incomingData) &&
        //   isOwner(getDocData(incomingData.creator).id)
        // );
      }

      function canDeleteEvent() {
        return (
          isOwner(getDocData(existingData().creator).id)
        )
      }

      allow read: if true;
      allow create: if canCreateEvent();
      allow update: if canUpdateEvent();
      allow delete: if canDeleteEvent();
      allow write: if false;
    }

    match /schools/{schoolId} {
      allow read: if true;
      allow write, create, update, delete: if false;
    }

    match /event-responses/{eventResponseId} {
      function canReadEventResponse() {
        return true;
        // return (
        //   isOwner(getDocData(existingData.user).id)
        // )
      }

      function canCreateEventResponse() {
        return (
          isSignedIn() &&
          isValidEventResponse()
        );
      }

      function isValidEventResponse() {
        let responseOptions = ["YES", "NO"];

        return (
          hasLength("response", 1, 5) &&
          isValidOption("response", responseOptions)
        );
        // return (
        //   incomingData.event is path &&
        //   incomingData.school is path &&
        //   incomingData.user is path &&
        //   docExists(incomingData.event.path) &&
        //   docExists(incomingData.school.path) &&
        //   docExists(incomingData.user.path) &&
        //   hasLength("response", 1, 5) &&
        //   isValidOption("response", ["YES", "NO"])
        // );
      }

      function canUpdateEventResponse() {
        return true;
        // return (
        //   canCreateEventResponse(incomingData) &&
        //   isOwner(getDocData(incomingData.user).id)
        // );
      }

      allow read: if true;
      allow create: if canCreateEventResponse();
      allow update: if canUpdateEventResponse();
      allow write, delete: if false;
    }

    match /game-queries/{gameQueryId} {
      allow read: if true;
      allow write, update, create, delete: if false;
    }


    ///////////////////////////////////////////////////////////////////////////
    // Shared Functions

    function currentUser() {
      return request.auth;
    }

    function requestingUser() {
      return currentUser().uid;
    }

    function isSignedIn() {
      return requestingUser() != null;
    }

    // Does the logged-in user match the requested userId?
    function isOwner(userId) {
      return (
        isSignedIn() &&
        requestingUser() == userId
      );
    }

    function isEmailVerified() {
      return currentUser().token.email_verified;
    }

    // Data that exists on the Firestore document
    function existingData() {
      return resource.data;
    }

    // Data that is sent to a Firestore document
    function incomingData() {
      return request.resource.data;
    }

    function documentFieldsCheckOut(requiredFields, optionalFields) {
        let allFields = requiredFields.concat(optionalFields);
        return (
          incomingData().keys().hasAll(requiredFields) &&
          incomingData().keys().hasOnly(allFields)
        );
    }

    // Check if document exists from reference path
    function docExists(path) {
      return exists(/databases/$(database)/documents/$(path));
    }

    // Fetch document data from reference path
    function getDocData(path) {
      return get(/databases/$(database)/documents/$(path)).data;
    }

    // Fetch the requesting user's data from Firestore
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(requestingUser())).data;
    }

    // Does the user have a school?
    function userHasSchool(userData) {
      return (
        docExists(userData.school.path)
      );
    }

    function has(field) {
      return field in incomingData().keys();
    }

    function val(field) {
      return incomingData()[field];
    }

    function isString(field) {
      return isValueString(val(field));
    }

    function isValueString(value) {
      return string(value) == value;
    }

    function hasLength(field, min, max) {
      return hasValueLength(val(field), min, max);
    }

    function hasValueLength(value, min, max) {
      return (
        isValueString(value) &&
        (min == 0 || value.size() >= min) &&
        (max == 0 || value.size() <= max)
      );
    }

    function isValidOption(field, options) {
      return val(field) in options;
    }

  }
}
